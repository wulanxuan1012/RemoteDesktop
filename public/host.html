<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>è¿œç¨‹æ¡Œé¢ - å±å¹•å…±äº«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        p {
            color: #888;
            margin-bottom: 30px;
        }

        #status {
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        #status.connected {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        #status.sharing {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        button {
            padding: 15px 40px;
            font-size: 18px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #preview {
            margin-top: 30px;
            max-width: 600px;
            width: 100%;
            border-radius: 10px;
            background: #000;
        }

        .viewers {
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .pin-card {
            margin: 30px 0;
            padding: 25px 40px;
            background: linear-gradient(135deg, rgba(46, 213, 115, 0.2), rgba(46, 213, 115, 0.1));
            border: 2px solid #2ed573;
            border-radius: 15px;
            text-align: center;
        }

        .pin-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 10px;
        }

        .pin-value {
            font-size: 48px;
            font-weight: bold;
            letter-spacing: 10px;
            color: #2ed573;
            font-family: 'Consolas', monospace;
        }

        .pin-hint {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            background: rgba(30, 30, 40, 0.95);
            border-left: 4px solid #fff;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            animation: slideIn 0.3s;
            color: #fff;
            min-width: 250px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            pointer-events: auto;
        }

        .toast-info {
            border-color: #2ed573;
        }

        .toast-warning {
            border-color: #ff4757;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(50px);
            }
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>
    <h1>ğŸ–¥ï¸ è¿œç¨‹æ¡Œé¢ - ä¸»æœºç«¯</h1>
    <p>åœ¨æ­¤ç”µè„‘ä¸Šå¼€å§‹å±å¹•å…±äº«</p>

    <div id="status">æœªè¿æ¥</div>

    <div class="pin-card">
        <div class="pin-label">ğŸ” æ‰‹æœºè®¿é—®éªŒè¯ç </div>
        <div class="pin-value" id="pinDisplay">------</div>
        <div class="pin-hint">æ‰‹æœºç«¯è®¿é—®æ—¶éœ€è¦è¾“å…¥æ­¤ PIN ç </div>
    </div>

    <button id="startBtn" disabled>å¼€å§‹å…±äº«</button>

    <video id="preview" autoplay muted playsinline></video>

    <div class="viewers">
        <span>ğŸ‘¥ è¿æ¥çš„è§‚çœ‹è€…: </span><span id="viewerCount">0</span>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const preview = document.getElementById('preview');
        const viewerCountEl = document.getElementById('viewerCount');

        let ws = null;
        let localStream = null;
        const peerConnections = new Map(); // viewerId -> RTCPeerConnection

        // è¿æ¥ WebSocket
        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}`);

            ws.onopen = () => {
                statusEl.textContent = 'å·²è¿æ¥æœåŠ¡å™¨';
                statusEl.className = 'connected';
                startBtn.disabled = false;

                // æ³¨å†Œä¸ºä¸»æœº
                ws.send(JSON.stringify({ type: 'register-host' }));

                // è·å–å½“å‰ PIN
                fetchPin();
            };

            ws.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                await handleMessage(message);
            };

            ws.onclose = () => {
                statusEl.textContent = 'è¿æ¥æ–­å¼€ï¼Œé‡è¿ä¸­...';
                statusEl.className = '';
                document.getElementById('pinDisplay').textContent = '------';
                startBtn.disabled = true;
                setTimeout(connect, 3000);
            };
        }

        async function handleMessage(message) {
            switch (message.type) {

                case 'registered':
                    statusEl.textContent = 'æœåŠ¡å™¨å·²è¿æ¥ï¼Œç­‰å¾…åˆ†é… ID...';
                    if (message.role === 'host') {
                        statusEl.textContent = 'å°±ç»ªï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å…±äº«';
                        statusEl.className = 'connected';
                        startBtn.disabled = false;
                        fetchPin(); // è·å– PIN
                    }
                    break;

                case 'notification':
                    showNotification(message.message, message.level);
                    break;

                case 'offer':
                    console.log('æ”¶åˆ° Offer from viewer:', message.viewerId);
                    await handleOffer(message.viewerId, message.sdp);
                    break;

                case 'ice-candidate':
                    const pc = peerConnections.get(message.viewerId);
                    if (pc && message.candidate) {
                        await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
                    }
                    break;
            }
        }

        async function handleOffer(viewerId, sdp) {
            console.log(`[handleOffer] viewerId=${viewerId}, localStream=${!!localStream}`);

            if (!localStream) {
                console.warn('æ²¡æœ‰åª’ä½“æµ');
                return;
            }

            console.log(`[handleOffer] localStream tracks:`, localStream.getTracks().map(t => ({ kind: t.kind, enabled: t.enabled, readyState: t.readyState })));

            const pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            peerConnections.set(viewerId, pc);
            viewerCountEl.textContent = peerConnections.size;

            // æ·»åŠ æœ¬åœ°æµ
            localStream.getTracks().forEach(track => {
                console.log(`[handleOffer] Adding track: ${track.kind}, enabled=${track.enabled}`);
                pc.addTrack(track, localStream);
            });

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        viewerId
                    }));
                }
            };

            pc.onnegotiationneeded = () => {
                console.log('[handleOffer] Negotiation needed');
            };

            pc.onconnectionstatechange = () => {
                console.log(`Viewer ${viewerId} çŠ¶æ€:`, pc.connectionState);
                if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                    peerConnections.delete(viewerId);
                    viewerCountEl.textContent = peerConnections.size;
                }
            };

            await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp }));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            console.log('[handleOffer] Answer SDP preview:', answer.sdp.substring(0, 200));

            ws.send(JSON.stringify({
                type: 'answer',
                sdp: answer.sdp,
                viewerId
            }));

            console.log('å·²å‘é€ Answer to viewer:', viewerId);
        }

        // å¼€å§‹å…±äº«
        startBtn.onclick = async () => {
            try {
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: 'always',
                        width: { ideal: 1280, max: 1920 }, // é™ä½é»˜è®¤åˆ†è¾¨ç‡
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 60 }  // é™ä½å¸§ç‡
                    },
                    audio: false
                });

                preview.srcObject = localStream;
                statusEl.textContent = 'æ­£åœ¨å…±äº«å±å¹•...';
                statusEl.className = 'sharing';
                startBtn.textContent = 'å…±äº«ä¸­...';
                startBtn.disabled = true;

                // ç›‘å¬åœæ­¢å…±äº«
                localStream.getVideoTracks()[0].onended = () => {
                    statusEl.textContent = 'å…±äº«å·²åœæ­¢';
                    statusEl.className = 'connected';
                    startBtn.textContent = 'å¼€å§‹å…±äº«';
                    startBtn.disabled = false;
                    localStream = null;

                    // å…³é—­æ‰€æœ‰è¿æ¥
                    peerConnections.forEach(pc => pc.close());
                    peerConnections.clear();
                    viewerCountEl.textContent = 0;
                };

            } catch (error) {
                console.error('å±å¹•å…±äº«å¤±è´¥:', error);
                alert('å±å¹•å…±äº«å¤±è´¥: ' + error.message);
            }
        };

        // è·å–å½“å‰ PIN ç 
        async function fetchPin() {
            try {
                const response = await fetch('/api/auth/pin');
                const data = await response.json();
                if (data.pin) {
                    document.getElementById('pinDisplay').textContent = data.pin;
                }
            } catch (e) {
                console.error('è·å– PIN å¤±è´¥:', e);
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(msg, level = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${level}`;
            toast.innerHTML = `<span style="font-size:18px;margin-right:10px">${level === 'info' ? 'ğŸ”—' : 'ğŸ”Œ'}</span> ${msg}`;
            container.appendChild(toast);

            playSound(level);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }

        // æ’­æ”¾æç¤ºéŸ³
        function playSound(type) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);

                if (type === 'info') { // è¿æ¥éŸ³: å‡è°ƒ
                    osc.frequency.setValueAtTime(500, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
                } else { // æ–­å¼€éŸ³: é™è°ƒ
                    osc.frequency.setValueAtTime(400, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.1);
                }

                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);

                osc.start();
                osc.stop(ctx.currentTime + 0.2);
            } catch (e) {
                // AudioContext å¯èƒ½è¢«ç”±äºæ²¡æœ‰äº¤äº’è€Œè¢«é˜»å¡ï¼Œå¿½ç•¥
            }
        }

        connect();
    </script>
</body>

</html>